<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Json schema inference</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.2.1/css/dataTables.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.2.0/css/buttons.dataTables.min.css" />

    <style>
        .resize-horizontal {
            resize: horizontal;
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .aspect-ratio-1x1 {
            aspect-ratio: 1;
        }

        .fs-0 {
            font-size: 3rem !important;
        }

        :root {
            --bs-primary: #089e0a;
            --bs-primary-bg-subtle: #056b07;
        }

        .btn-hover-primary {
            --bs-btn-color: var(--bs-gray-300);
            --bs-btn-bg: transparent;
            --bs-btn-border-color: var(--bs-gray-300);
            --bs-btn-hover-color: var(--bs-white);
            --bs-btn-hover-bg: var(--bs-primary);
            --bs-btn-hover-border-color: var(--bs-primary);
            --bs-btn-focus-shadow-rgb: 49, 132, 253;
            --bs-btn-active-color: var(--bs-white);
            --bs-btn-active-bg: var(--bs-primary-bg-subtle);
            --bs-btn-active-border-color: var(--bs-primary-bg-subtle);
            --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
            --bs-btn-disabled-color: var(--bs-white);
            --bs-btn-disabled-bg: var(--bs-gray-300);
            --bs-btn-disabled-border-color: var(--bs-gray-300);
        }
    </style>
</head>

<body>
    <div class="d-flex flex-column min-vh-100">
        <div class="text-light bg-dark font-monospace px-3 py-1">
            <span class="fs-2">Json schema inference</span>
            <span class="ps-1" style="font-size: 0.8rem;">（使用方法については、<a href="#">こちら</a>をご覧ください）</span>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/2.2.1/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.0/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.0/js/buttons.colVis.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.0/js/buttons.print.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.0/js/buttons.html5.min.js"></script>
    <script>
        if (Array.prototype.unique === undefined) {
            Array.prototype.unique = function () {
                return Array.from(new Set(this));
            }
        }

        class Record {
            constructor(parameters) {
                Object.assign(this, parameters);
                this.name ??= '';
                this.ancestors ??= [];
                this.children ??= [];
            }

            get type() {
                return typeof this.value === 'object' && this.value !== null && this.value.constructor.name === 'Array'
                    ? 'array'
                    : typeof this.value;
            }

            get path() {
                return [...this.ancestors, this]
                    .map(({ name, ancestors }) => [JSON.stringify(name).slice(1, -1), ancestors])
                    .reduce((path, [name, ancestors]) => ancestors.at(-1)?.type === 'array' ? `${path}[${name}]` : `${path}/${name}`, '')
                    .replace(/^\/\//, '/')
            }

            get schemaId() {
                return [...this.ancestors, this]
                    .map(({ name, ancestors }) => [JSON.stringify(name).slice(1, -1), ancestors])
                    .reduce((path, [name, ancestors]) => ancestors.at(-1)?.type === 'array' ? `${path}[]` : `${path}/${name}`, '')
                    .replace(/^\/\//, '/')
            }
        }
        class Model {
            parseJson(json) {
                return new Promise((resolve, reject) => {
                    let stack;
                    try {
                        stack = [new Record({ value: JSON.parse(json) })];
                    } catch (e) {
                        resolve(undefined);
                        return;
                    }

                    this.records = [];
                    do {
                        const record = stack.shift();

                        if (['object', 'array'].includes(record.type) && record.value !== null) {
                            record.children.push(...Object.keys(record.value).map(name => new Record({
                                value: record.value[name],
                                name: name,
                                ancestors: record.ancestors.concat(record),
                            })));
                            stack.unshift(...record.children);
                        }

                        this.records.push(record);
                    } while (stack.length > 0);

                    resolve(this.records);
                });
            }
        }

        class AbstractTableView {
            constructor($element, parameters = {}) {
                this.$element = $element;
                this.$table = $element
                    .on('init.dt', function () {
                        const $root = $(this).closest('div[id^=DataTables_Table_');

                        // re-layout for top2
                        $root
                            .children(':first')
                            .find('div[class="dt-search"]')
                            .addClass('w-100')
                            .append(
                                $('<div>')
                                    .addClass('position-relative')
                                    .append(
                                        $('<div>')
                                            .addClass('input-group')
                                            .append(
                                                $('<span>')
                                                    .addClass('input-group-text bi bi-search'),
                                                $root.find('[type="search"]')
                                                    .addClass('flex-fill')),
                                        $('<button>')
                                            .attr({
                                                type: 'button',
                                                'data-bs-toggle': 'button',
                                                style: 'height: calc(100% - 6px); top: 50%; right: 3px; transform: translateY(-50%)',
                                            })
                                            .addClass('position-absolute aspect-ratio-1x1 border-0 p-0 btn btn-outline-primary font-monospace bi bi-regex')));

                        // top1
                        $root

                    })
                    .DataTable({
                        columnDefs: [
                            {
                                targets: 0, width: '40%', render: function (data) {
                                    // there are no space characters in the json keys, so the browser will not wrap them.
                                    // the following code forces word wrapping for json keys.
                                    return `<p class="m-0" style="word-wrap: break-word;">${data}</p>`
                                }
                            },
                            { targets: 1, width: '5em' },
                            { targets: 2, className: 'text-truncate' },
                        ],
                        layout: {
                            top2: { search: { text: '', placeholder: 'Filter...' } },
                            topStart: null,
                            topEnd: null,
                            bottomStart: null,
                            bottomEnd: null,
                        }
                    });
            }
        }
        class SchemaView extends AbstractTableView { }
        class RecordsView extends AbstractTableView { }
        class View {
            constructor(model) {
                this.textPane = class {
                    expandTextPane() {
                        const pane = $('[data-id="textPane"]');
                        pane.css({ width: '50%' });

                    }
                    collapseTextPane() {
                        const pane = $('[data-id="textPane"]');
                        pane.css({ width: 'auto' });
                    }
                    get textPaneExpanded() {
                    }
                }
                this.records = new RecordsView($('[data-id="record"]'));
                this.schema = new SchemaView($('[data-id="schema"]'));
            }

            get $text() {
                return $('[data-id="text"]');
            }
            get text() {
                return $('[data-id="text"]')[0].value;
            }



        }

        class Controller {
            constructor(model, view) {
                view.$text
                    .on('input', async function () {
                        const records = await model.parseJson(view.text);
                        if (records === undefined) return;

                        $('[data-id="records"]').DataTable()
                            .clear()
                            .rows.add(records
                                .map(record => [
                                    record.path,
                                    record.type,
                                    JSON.stringify(record.value).replace(/^"|"$/g, '')
                                ]))
                            .draw();
                        $('[data-id="schema"]').DataTable()
                            .clear()
                            .rows.add(Object
                                .values(Object.groupBy(records, record => record.schemaId))
                                .map(groupedRecords => [
                                    groupedRecords[0].schemaId,
                                    groupedRecords[0].type,
                                    groupedRecords
                                        .map(({ type, value }) => type === 'string' ? value : JSON.stringify(value))
                                        .filter(value => value !== '')
                                        .unique()
                                        .sort()
                                        .join(', '),
                                ]))
                            .draw();
                    });
            }
        }

        $(function () {
            const model = new Model();
            const view = new View(model);
            const controller = new Controller(model, view);
        });
    </script>
</body>

</html>